{"version":3,"sources":["../../src/middleware/addUserToReq.js"],"names":["addUserToReq","req","res","next","token","headers","user","_id","username","role","createdAt","decodeToken","verify","jwtSecret","findOneAndUpdate","Types","ObjectId","$set","lastOnlineAt","pick"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEA,IAAMA;AAAA,oEAAe,iBAAOC,GAAP,EAAYC,GAAZ,EAAiBC,IAAjB;AAAA;AAAA;AAAA;AAAA;AAAA;AACdC,WADc,GACNH,IAAII,OAAJ,CAAY,eAAZ,CADM;;AAEpB,UAAG,CAACD,KAAJ,EAAW;AACVH,WAAIK,IAAJ,GAAW,EAAEC,KAAK,EAAP,EAAWC,UAAU,QAArB,EAA+BC,MAAM,OAArC,EAA8CC,WAAW,uBAAzD,EAAX;AACAP;AACA;AALmB;AAObQ,iBAPa,GAOC,uBAAIC,MAAJ,CAAWR,KAAX,EAAkB,iBAAOS,SAAzB,CAPD;AAAA;AAAA,aAQA,eAAKC,gBAAL,CAAsB,EAAEP,KAAK,mBAASQ,KAAT,CAAeC,QAAf,CAAwBL,YAAYJ,GAApC,CAAP,EAAtB,EAAyE,EAACU,MAAM,EAAEC,cAAc,uBAAhB,EAAP,EAAzE,CARA;;AAAA;AAQbZ,UARa;;AASnBL,UAAIK,IAAJ,GAAW,iBAAEa,IAAF,CAAOb,IAAP,EAAa,CAAC,KAAD,EAAQ,UAAR,EAAoB,MAApB,EAA4B,WAA5B,CAAb,CAAX;AACAH;AAVmB;AAAA;;AAAA;AAAA;AAAA;;AAYnBF,UAAIK,IAAJ,GAAW,EAAEC,KAAK,EAAP,EAAWC,UAAU,QAArB,EAA+BC,MAAM,OAArC,EAA8CC,WAAW,uBAAzD,EAAX;AACAP;;AAbmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAAf;;AAAA;AAAA;AAAA;AAAA,GAAN;;kBAiBeH,Y","file":"addUserToReq.js","sourcesContent":["import mongoose from 'mongoose';\nimport jwt from 'jsonwebtoken';\nimport moment from 'moment';\nimport config from '../config';\nimport User from '../models/User';\nimport _ from 'lodash';\n\nconst addUserToReq = async (req, res, next) => {\n\tconst token = req.headers['authorization'];\n\tif(!token) {\n\t\treq.user = { _id: '', username: 'vistor', role: 'Guest', createdAt: moment() };\n\t\tnext();\n\t}\n\ttry {\n\t\tconst decodeToken = jwt.verify(token, config.jwtSecret);\n\t\tconst user = await User.findOneAndUpdate({ _id: mongoose.Types.ObjectId(decodeToken._id) }, {$set: { lastOnlineAt: moment() }});\n\t\treq.user = _.pick(user, ['_id', 'username', 'role', 'createdAt']);\n\t\tnext();\n\t} catch (e) {\n\t\treq.user = { _id: '', username: 'vistor', role: 'Guest', createdAt: moment() };\n\t\tnext();\n\t}\n};\n\nexport default addUserToReq;"]}