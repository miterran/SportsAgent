{"version":3,"sources":["../src/index.js"],"names":["dirname","__dirname","connect","mongoURL","useMongoClient","Promise","app","use","json","urlencoded","extended","static","join","resolve","get","req","res","userCounter","scheduleJob","console","log","length","deleteExpiredUnpickEvents","resetWeeklyBalanceToZero","schema","context","user","endpointURL","subscriptionsEndpoint","WSURL","sendFile","ws","listen","process","env","PORT","execute","subscribe","onConnect","connectionParams","webSocket","includes","upgradeReq","headers","push","onDisconnect","filter","server","path"],"mappings":"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","file":"index.js","sourcesContent":["import 'babel-polyfill';\n\nimport config from './config';\nimport express from 'express';\nimport path from 'path';\nimport { createServer } from 'http';\nimport cors from 'cors';\nimport morgan from 'morgan';\nimport bodyParser from 'body-parser';\nimport compress from 'compression';\nimport helmet from 'helmet';\nimport methodOverride from 'method-override';\n\nimport schedule from 'node-schedule';\n\nimport mongoose from 'mongoose';\nimport bluebird from 'bluebird';\n\nimport { graphqlExpress, graphiqlExpress } from 'apollo-server-express';\nimport { execute, subscribe } from 'graphql';\nimport { SubscriptionServer } from 'subscriptions-transport-ws';\nimport schema from './graphql/schema';\n\nimport addUserToReq from './middleware/addUserToReq';\n\nimport updateEvents from './queues/updateEvents';\n//import updateTables from './queues/updateTables';\n\nimport moment from 'moment';\n\nimport updateScoreFromPickMon from './services/updateScores/pickMon';\nimport updateScoreFromJsonOdd from './services/updateScores/jsonOdd';\nimport updatePicks from './services/updatePicks';\nimport updateBetOrders from './services/updateBetOrders';\nimport Event from './models/Event';\nimport Player from './models/User.Player';\nimport Pick from './models/Pick';\n// import apn from 'apn'\nexport const dirname = __dirname;\nmongoose.connect(config.mongoURL, { useMongoClient: true });\nmongoose.Promise = bluebird;\nconst app = express();\napp.use(morgan('dev'));\napp.use(cors());\napp.use(helmet());\napp.use(compress());\napp.use(methodOverride());\napp.use(bodyParser.json());\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use('/images/teamlogos', express.static(path.join(__dirname, '/public/images/teamlogos/baseball')));\napp.use('/images/teamlogos', express.static(path.join(__dirname, '/public/images/teamlogos/basketball')));\napp.use('/images/teamlogos', express.static(path.join(__dirname, '/public/images/teamlogos/football')));\napp.use('/images/teamlogos', express.static(path.join(__dirname, '/public/images/teamlogos/ncaa')));\napp.use('/images/teamlogos', express.static(path.join(__dirname, '/public/images/teamlogos/hockey')));\napp.use('/images/teamlogos', express.static(path.join(__dirname, '/public/images/teamlogos/sport')));\napp.use(express.static(path.resolve(__dirname, '../client/build')))\napp.get('/hi', async (req, res) => {\n\t// const pick = await Pick.findOneAndUpdate({ ID: '63d5f02c-f2a1-415a-b76f-937f16d76b8e_SPREAD_HOME' }).populate('Event').populate('Agent').populate('Player')\n\t// res.json(pick)\n//\tawait Event.findOneAndRemove({ ID: '1521807' })\nawait updateEvents();\n\tres.json('done')\n})\nlet userCounter = [];\nschedule.scheduleJob('*/3 * * * *', async () => {\n\t// eslint-disable-next-line\n\tconsole.log('scheduleJob usercounter', moment(), userCounter.length);\n\tif(userCounter.length > 0){\n\t\tawait updateEvents();\n\t}\n});\nschedule.scheduleJob('*/15 * * * *', async () => {\n\tawait updateScoreFromJsonOdd();\n\tawait updateScoreFromPickMon();\n\tawait updatePicks();\n\tawait updateBetOrders();\n\tawait Event.deleteExpiredUnpickEvents();\n\tawait Player.resetWeeklyBalanceToZero();\n});\napp.use(addUserToReq);\napp.use('/graphql', \n\tgraphqlExpress((req) => {\n\t\treturn ({\n\t\t\tschema, \n\t\t\tcontext: { user: req.user }\n\t\t});\n\t})\n);\napp.use('/graphiql', graphiqlExpress({ \n\tendpointURL: '/graphql',\n\tsubscriptionsEndpoint: config.WSURL\n//\tsubscriptionsEndpoint: 'ws://sportsagentapp.herokuapp.com/subscriptions'\n}));\napp.get('/app', (req, res) => res.sendFile(path.resolve(__dirname, '../client/build', 'index.html')))\nconst ws = createServer(app);\nws.listen(process.env.PORT, () => { \n\t// eslint-disable-next-line\n\tconsole.log(`Apollo Server is now running on http://localhost:${process.env.PORT}`); \n\n\tnew SubscriptionServer({\n\t\texecute,\n\t\tsubscribe,\n\t\tschema,\n\t\tonConnect: (connectionParams, webSocket) => {\n\t\t\tif(!userCounter.includes(webSocket.upgradeReq.headers['sec-websocket-key'])) {\n\t\t\t\tuserCounter.push(webSocket.upgradeReq.headers['sec-websocket-key']);\n\t\t\t}\n\t\t\t// eslint-disable-next-line\n\t\t\tconsole.log(userCounter.length);\n\t\t\tif(userCounter.length === 1){ (async() => await updateEvents())();}\n\t\t},\n\t\tonDisconnect: (webSocket) => {\n\t\t\tuserCounter = userCounter.filter(user => user !== webSocket.upgradeReq.headers['sec-websocket-key']);\n\t\t\t// eslint-disable-next-line\n\t\t\tconsole.log(userCounter.length);\n\t\t},\n\t}, {\n\t\tserver: ws,\n\t\tpath: '/subscriptions',\n\t});\n\n});\n\n"]}