{"version":3,"sources":["../../../../src/graphql/resolvers/Transaction/index.js"],"names":["Query","transactions","root","ctx","startOfWeekNum","endOfWeekNum","user","role","findOne","_id","Types","ObjectId","agent","available","credit","pendingTransactions","find","Agent","createdAt","$gte","add","Number","startOf","$lte","endOf","sort","isClosed","populate","path","select","openBets","map","pending","process","ID","openBet","type","description","Player","username","title","amount","bet","atRisk","balance","concat"],"mappings":";;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEO,IAAMA,wBAAQ;AACdC,aADc,wBACDC,IADC,QACuCC,GADvC,EAC2C;AAAA;;AAAA,MAApCC,cAAoC,QAApCA,cAAoC;AAAA,MAApBC,YAAoB,QAApBA,YAAoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAC3DF,IAAIG,IAAJ,CAASC,IAAT,KAAkB,OADyC;AAAA;AAAA;AAAA;;AAAA,wCACzB,IADyB;;AAAA;AAAA;AAAA,cAE1C,eAAMC,OAAN,CAAc,EAAEC,KAAK,mBAASC,KAAT,CAAeC,QAAf,CAAwBR,IAAIG,IAAJ,CAASG,GAAjC,CAAP,EAAd,CAF0C;;AAAA;AAExDG,YAFwD;AAG1DC,gBAH0D,GAG9CD,MAAME,MAAN,CAAaD,SAHiC;AAI1DE,0BAJ0D,GAIpC,EAJoC;AAAA;AAAA,cAKrC,sBAAYC,IAAZ,CAAiB;AACzCC,eAAO,mBAASP,KAAT,CAAeC,QAAf,CAAwBR,IAAIG,IAAJ,CAASG,GAAjC,CADkC;AAEzCS,mBAAW,EAACC,MAAM,wBAASC,GAAT,CAAaC,OAAOjB,cAAP,CAAb,EAAqC,GAArC,EAA0CkB,OAA1C,CAAkD,SAAlD,CAAP;AACVC,eAAM,wBAASH,GAAT,CAAaC,OAAOhB,YAAP,CAAb,EAAmC,GAAnC,EAAwCmB,KAAxC,CAA8C,SAA9C,CADI;AAF8B,QAAjB,EAItBC,IAJsB,CAIjB,EAAEP,WAAW,YAAb,EAJiB,CALqC;;AAAA;AAK1DjB,mBAL0D;;AAAA,aAU1DG,mBAAmB,CAAnB,IAAwBC,iBAAiB,CAViB;AAAA;AAAA;AAAA;;AAAA;AAAA,cAWtC,mBAASW,IAAT,CAAc,EAAEC,OAAO,mBAASP,KAAT,CAAeC,QAAf,CAAwBR,IAAIG,IAAJ,CAASG,GAAjC,CAAT,EAAgDiB,UAAU,KAA1D,EAAd,EAAiFC,QAAjF,CAA0F,EAAEC,MAAM,QAAR,EAAkBC,QAAQ,UAA1B,EAA1F,EAAiIJ,IAAjI,CAAsI,EAAEP,WAAW,YAAb,EAAtI,CAXsC;;AAAA;AAWvDY,eAXuD;;AAY7Df,6BAAsBe,SAASC,GAAT,CAAa,mBAAW;AAC7C,YAAIC,UAAU;AACbvB,cAAK,iBAAOwB,OAAP,EADQ;AAEbC,aAAIC,QAAQD,EAFC;AAGbE,eAAM,SAHO;AAIbC,4BAAiBF,QAAQG,MAAR,CAAeC,QAAhC,iBAAoDJ,QAAQK,KAJ/C;AAKbtB,oBAAWiB,QAAQjB,SALN;AAMbuB,iBAAQN,QAAQO,GAAR,CAAYC,MANP;AAObC,kBAAS/B;AAPI,SAAd;AASAA,qBAAasB,QAAQO,GAAR,CAAYC,MAAzB;AACA,eAAOX,OAAP;AACA,QAZqB,CAAtB;;AAZ6D;AAAA,wCA0BvDjB,oBAAoB8B,MAApB,CAA2B5C,YAA3B,CA1BuD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA2B9D;AA5BmB,CAAd","file":"index.js","sourcesContent":["import mongoose from 'mongoose';\nimport Transaction from '../../../models/Transaction';\nimport BetOrder from '../../../models/BetOrder';\nimport moment from 'moment';\nimport uniqid from 'uniqid';\nimport Agent from '../../../models/User.Agent';\n\nexport const Query = {\n\tasync transactions(root, { startOfWeekNum, endOfWeekNum }, ctx){\n\t\tif(ctx.user.role !== 'Agent') return null;\n\t\tconst agent = await\tAgent.findOne({ _id: mongoose.Types.ObjectId(ctx.user._id) });\n\t\tlet available = agent.credit.available;\n\t\tlet pendingTransactions = [];\n\t\tlet transactions = await Transaction.find({ \n\t\t\tAgent: mongoose.Types.ObjectId(ctx.user._id), \n\t\t\tcreatedAt: {$gte: moment().add(Number(startOfWeekNum), 'w').startOf('isoWeek'), \n\t\t\t\t$lte: moment().add(Number(endOfWeekNum), 'w').endOf('isoWeek') } \n\t\t}).sort({ createdAt: 'descending' });\n\t\tif( startOfWeekNum === 0 && endOfWeekNum === 0) {\n\t\t\tconst openBets = await BetOrder.find({ Agent: mongoose.Types.ObjectId(ctx.user._id), isClosed: false }).populate({ path: 'Player', select: 'username'}).sort({ createdAt: 'descending' });\n\t\t\tpendingTransactions = openBets.map(openBet => {\n\t\t\t\tlet pending = {\n\t\t\t\t\t_id: uniqid.process(),\n\t\t\t\t\tID: openBet.ID,\n\t\t\t\t\ttype: 'Pending',\n\t\t\t\t\tdescription: `(${openBet.Player.username}) placed ${openBet.title}`,\n\t\t\t\t\tcreatedAt: openBet.createdAt,\n\t\t\t\t\tamount: openBet.bet.atRisk,\n\t\t\t\t\tbalance: available\n\t\t\t\t};\n\t\t\t\tavailable += openBet.bet.atRisk;\n\t\t\t\treturn pending;\n\t\t\t});\n\t\t}\n\t\treturn pendingTransactions.concat(transactions);\n\t}\n};\n\n"]}